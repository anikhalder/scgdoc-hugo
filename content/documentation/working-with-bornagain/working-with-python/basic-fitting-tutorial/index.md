+++
title = "Basic fitting tutorial"
weight = 75
+++

## Basic fitting tutorial

In this section we are going to go through a complete example of fitting using BornAgain.
Each step will be associated with a detailed piece of code written in Python.
The script can also be found in the [Fit Cylinders and Prisms]({{% relref "documentation/python-examples/fitting/FitCylindersPrisms.md" %}}) example.

This example uses the same sample geometry as in [Basic simulation tutorial]({{% relref "documentation/working-with-bornagain/working-with-python/basic-simulation-tutorial/index.md" %}}).
Cylindrical and prismatic particles in equal proportion are deposited on a substrate layer,
with no interference between the particles. We consider the following parameters to be unkown:

* the radius of cylinders,
* the height of cylinders,
* the length of the prisms' triangular basis,
* the height of prisms.

Our reference data are a "noisy" two-dimensional intensity map obtained from the simulation of the same geometry 
with a fixed value of 5nmfor the height and radius of cylinders and for the height
of prisms which have a 10-nanometer-long side length.
Then we run our fitting using default minimizer settings starting with a cylinder's height of 4 nm, 
a cylinder's radius of 6 nm, a prism's half side of 6 nm and a height equal to 4 nm.
As a result, the fitting procedure is able to find the correct value of 5 nm for all four parameters.

### Importing python libraries

{{< highlight python "linenos=table,linenostart=4" >}}

import bornagain as ba
from bornagain import deg, angstrom, nm

{{< /highlight >}}

We start from import of the BornAgain Python API and particularly dimension units defined in BornAgain.

### Building the sample

{{< highlight python "linenos=table,linenostart=8" >}}

def get_sample(cylinder_height=5.0*nm, cylinder_radius=5.0*nm,
               prism_length=5.0*nm, prism_height=5.0*nm):
    """
    Returns a sample with uncorrelated cylinders and prisms on a substrate.
    """
    # defining materials
    m_air = ba.HomogeneousMaterial("Air", 0.0, 0.0)
    m_substrate = ba.HomogeneousMaterial("Substrate", 6e-6, 2e-8)
    m_particle = ba.HomogeneousMaterial("Particle", 6e-4, 2e-8)

    # collection of particles
    cylinder_ff = ba.FormFactorCylinder(cylinder_radius, cylinder_height)
    cylinder = ba.Particle(m_particle, cylinder_ff)
    prism_ff = ba.FormFactorPrism3(prism_length, prism_height)
    prism = ba.Particle(m_particle, prism_ff)
    particle_layout = ba.ParticleLayout()
    particle_layout.addParticle(cylinder, 0.5)
    particle_layout.addParticle(prism, 0.5)
    interference = ba.InterferenceFunctionNone()
    particle_layout.setInterferenceFunction(interference)

    # air layer with particles and substrate form multi layer
    air_layer = ba.Layer(m_air)
    air_layer.addLayout(particle_layout)
    substrate_layer = ba.Layer(m_substrate, 0)
    multi_layer = ba.MultiLayer()
    multi_layer.addLayer(air_layer)
    multi_layer.addLayer(substrate_layer)
    return multi_layer

{{< /highlight >}}

The function starting at line 8 creates a multilayered sample 
with cylinders and prisms using arbitrary 1 nm value for all size's of particles.
The details about the generation of this
multilayered sample are given in the [Basic simulation tutorial]({{% relref "documentation/working-with-bornagain/working-with-python/basic-simulation-tutorial/index.md" %}}).

### Creating the simulation

{{< highlight python "linenos=table,linenostart=39" >}}

def get_simulation():
    """
    Returns a GISAXS simulation with beam and detector defined
    """
    simulation = ba.GISASSimulation()
    simulation.setDetectorParameters(100, -1.0*deg, 1.0*deg,
                                     100, 0.0*deg, 2.0*deg)
    simulation.setBeamParameters(1.0*angstrom, 0.2*deg, 0.0*deg)
    simulation.setBeamIntensity(1e+08)
    return simulation

{{< /highlight >}}

The function starting at line 39 creates the simulation object with the definition of the beam and detector parameters.

### Preparing the fitting pair

{{< highlight python "linenos=table,linenostart=51" >}}

def run_fitting():
    """
    run fitting
    """
    sample = get_sample()
    simulation = get_simulation()
    simulation.setSample(sample)

    real_data = ba.IntensityDataIOFactory.readIntensityData(
        'refdata_fitcylinderprisms.int.gz')

{{< /highlight >}}

Lines 49-51 generate the sample and simulation description and assign the sample to the simulation.
Our reference data are contained in the file `refdata_fitcylinderprisms.int.gz`.
This reference had been generated by adding noise on the scattered intensity froma numerical sample with
a fixed length of <nobr>5 nm</nobr> for the four fitting parameters (i.e. the dimensions of the cylinders and prisms).
Lines 59-60 create the real data object by loading the ASCII data fromthe input file.

### Setting up FitSuite

{{< highlight python "linenos=table,linenostart=62" >}}

    fit_suite = ba.FitSuite()
    fit_suite.addSimulationAndRealData(simulation, real_data)
    fit_suite.initPrint(10)

{{< /highlight >}}

Line 62 creates a FitSuite object which provides the main interface to the minimization kernel of BornAgain.
Line 63 submits simulation description and real data pair to the subsequent fitting.
Line 64 sets up FitSuite to print on the screen the information about fit progress once per 10 iterations.

{{< highlight python "linenos=table,linenostart=66" >}}

    # setting fitting parameters with starting values
    fit_suite.addFitParameter("*Cylinder/Height", 4.*nm).setLowerLimited(0.01)
    fit_suite.addFitParameter("*Cylinder/Radius", 6.*nm).setLowerLimited(0.01)
    fit_suite.addFitParameter("*Prism3/Height", 4.*nm).setLowerLimited(0.01)
    fit_suite.addFitParameter("*Prism3/BaseEdge", 12.*nm).setLowerLimited(0.01)

{{< /highlight >}}

Lines 67-70 enter the list of fitting parameters. Here we use the cylinders' height and radius and the prisms' height and half-side length.
The cylinder's length and prism half-side are initially equal to 4 nm, whereas the cylinder's radius and the prism half-side length are equal
to 6 nm before the minimization. For each fit parameter the lower boundary is imposed to be equal to 0.01 nm.

### Running the fit and accessing the results

{{< highlight python "linenos=table,linenostart=72" >}}

    # running fit
    fit_suite.runFit()

    print("Fitting completed.")
    print("chi2:", fit_suite.getChi2())
    for par in fit_suite.fitParameters():
        print(par.name(), par.value(), par.error())

{{< /highlight >}}

Line 73 shows the command to start the fitting process.
During the fitting the progress will be displayed on the screen.
Lines 76â€“78 show different ways of accessing the fit results.

